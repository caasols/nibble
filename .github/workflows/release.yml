name: Release

on:
  push:
    tags:
      - "v*"
  workflow_dispatch:
    inputs:
      tag_name:
        description: "Tag to release (example: v1.0.1)"
        required: true
        type: string

permissions:
  contents: write

jobs:
  build-sign-notarize:
    runs-on: macos-15
    env:
      APP_NAME: Nibble
      EXPECTED_BUNDLE_ID: com.caasols.nibble

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Select Xcode
        uses: maxim-lobanov/setup-xcode@v1
        with:
          xcode-version: latest-stable

      - name: Resolve release tag
        id: tag
        run: |
          if [[ "${GITHUB_EVENT_NAME}" == "workflow_dispatch" ]]; then
            echo "value=${{ inputs.tag_name }}" >> "$GITHUB_OUTPUT"
          else
            echo "value=${GITHUB_REF_NAME}" >> "$GITHUB_OUTPUT"
          fi

      - name: Validate release tag matches app version
        env:
          RELEASE_TAG: ${{ steps.tag.outputs.value }}
        run: |
          if [[ ! "${RELEASE_TAG}" =~ ^v[0-9]+\.[0-9]+\.[0-9]+$ ]]; then
            echo "Release tag must follow v<major>.<minor>.<patch>. Got: ${RELEASE_TAG}"
            exit 1
          fi

          TAG_VERSION="${RELEASE_TAG#v}"
          PLIST_VERSION=$(/usr/libexec/PlistBuddy -c "Print :CFBundleShortVersionString" Nibble/Resources/Info.plist)

          if [[ "${TAG_VERSION}" != "${PLIST_VERSION}" ]]; then
            echo "Tag version (${TAG_VERSION}) does not match Info.plist version (${PLIST_VERSION})."
            exit 1
          fi

      - name: Import Developer ID certificate
        env:
          CERT_BASE64: ${{ secrets.APPLE_DEVELOPER_ID_APPLICATION_CERT_BASE64 }}
          CERT_PASSWORD: ${{ secrets.APPLE_DEVELOPER_ID_APPLICATION_CERT_PASSWORD }}
        run: |
          if [[ -z "${CERT_BASE64}" || -z "${CERT_PASSWORD}" ]]; then
            echo "Missing release signing certificate secrets."
            exit 1
          fi

          KEYCHAIN_PATH="$RUNNER_TEMP/release-signing.keychain-db"
          CERT_PATH="$RUNNER_TEMP/developer-id.p12"
          KEYCHAIN_PASSWORD="${{ github.run_id }}-${{ github.run_attempt }}"

          echo "${CERT_BASE64}" | base64 --decode > "$CERT_PATH"

          security create-keychain -p "$KEYCHAIN_PASSWORD" "$KEYCHAIN_PATH"
          security set-keychain-settings -lut 21600 "$KEYCHAIN_PATH"
          security unlock-keychain -p "$KEYCHAIN_PASSWORD" "$KEYCHAIN_PATH"
          security list-keychains -d user -s "$KEYCHAIN_PATH"
          security default-keychain -d user -s "$KEYCHAIN_PATH"

          security import "$CERT_PATH" \
            -k "$KEYCHAIN_PATH" \
            -P "$CERT_PASSWORD" \
            -T /usr/bin/codesign \
            -T /usr/bin/security

          security set-key-partition-list \
            -S apple-tool:,apple:,codesign: \
            -s \
            -k "$KEYCHAIN_PASSWORD" \
            "$KEYCHAIN_PATH"

      - name: Prepare notarization key
        env:
          NOTARY_API_KEY_BASE64: ${{ secrets.APPLE_NOTARY_API_KEY_BASE64 }}
        run: |
          if [[ -z "${NOTARY_API_KEY_BASE64}" ]]; then
            echo "Missing notarization key secret."
            exit 1
          fi
          mkdir -p "$RUNNER_TEMP/notary"
          echo "${NOTARY_API_KEY_BASE64}" | base64 --decode > "$RUNNER_TEMP/notary/AuthKey.p8"

      - name: Build, sign, notarize, and package
        env:
          RELEASE_TAG: ${{ steps.tag.outputs.value }}
          APPLE_SIGNING_IDENTITY: ${{ secrets.APPLE_SIGNING_IDENTITY }}
          APPLE_TEAM_ID: ${{ secrets.APPLE_TEAM_ID }}
          APPLE_NOTARY_KEY_ID: ${{ secrets.APPLE_NOTARY_KEY_ID }}
          APPLE_NOTARY_ISSUER_ID: ${{ secrets.APPLE_NOTARY_ISSUER_ID }}
          APPLE_NOTARY_API_KEY_PATH: ${{ runner.temp }}/notary/AuthKey.p8
        run: |
          if [[ -z "${APPLE_SIGNING_IDENTITY}" || -z "${APPLE_TEAM_ID}" || -z "${APPLE_NOTARY_KEY_ID}" || -z "${APPLE_NOTARY_ISSUER_ID}" ]]; then
            echo "Missing required release secrets for signing/notarization."
            exit 1
          fi

          chmod +x scripts/release/sign-and-package.sh
          scripts/release/sign-and-package.sh

      - name: Run artifact hygiene checks
        env:
          RELEASE_TAG: ${{ steps.tag.outputs.value }}
        run: |
          chmod +x scripts/release/check-artifact-hygiene.sh
          scripts/release/check-artifact-hygiene.sh \
            --app-path "dist/Nibble.app" \
            --zip-path "dist/Nibble-${RELEASE_TAG}-macOS.zip" \
            --expected-bundle-id "${EXPECTED_BUNDLE_ID}" \
            --expected-top-level "Nibble.app/"

      - name: Upload release artifact
        uses: actions/upload-artifact@v4
        with:
          name: nibble-${{ steps.tag.outputs.value }}-macos
          path: |
            dist/Nibble-${{ steps.tag.outputs.value }}-macOS.zip
            dist/Nibble-${{ steps.tag.outputs.value }}-macOS.zip.sha256

      - name: Publish GitHub Release
        uses: softprops/action-gh-release@v2
        with:
          tag_name: ${{ steps.tag.outputs.value }}
          generate_release_notes: true
          files: |
            dist/Nibble-${{ steps.tag.outputs.value }}-macOS.zip
            dist/Nibble-${{ steps.tag.outputs.value }}-macOS.zip.sha256
